<!DOCTYPE html>
<html lang="en">
<head>
  <title>three.js webgl - geometry - extrude shapes from geodata</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
  <script type="text/javascript" src="../../jquery-ui/external/jquery.js"></script>
  <script type="text/javascript" src="../../paperjs/dist/paper-full.js"></script>
  <script type="text/javascript" src="js/three.js"></script>
  <script type="text/javascript" src="js/d3-threeD.js"></script>
  <script type="text/javascript" src="js/Project.js"></script>
  <script type="text/javascript" src="js/offset.js"></script>

  <script src="js/OrbitControls.js"></script>
  <style>
    #modelContainer {
      position: absolute;
      width: 1280px;
      height:800px;
      top:0;
      bottom: 0;
      left: 0;
      right:0;
      margin: auto;
      background: url("scene_pics/scene1.png") no-repeat center top;
      -webkit-background-size: contain;
      -moz-background-size: contain;
      -o-background-size: contain;
      background-size: contain;
      overflow: hidden;
    }

    #modelCanvasContainer {
      position: absolute;
      width: 50%;
      height:50%;
      top: 25%;
      left: 10%;
    }

    #modelCloseButton {
      position: absolute;
      right: 10%;
      bottom: 10%;
    }

  </style>
</head>

<body>
  <div id="modelContainer" >
    <div id="modelCanvasContainer" ></div>
    <div id="modelInfo"></div>
    <button id="modelCloseButton" onclick="window.close()">Close</button>
  </div>
  <div id="other" style="display: none"><canvas width="1000" height="1000" id='pa'></canvas></div>
  <script>

  window.onresize = function(event) {
    resize();
  }
  function resize(){
    var vpw = $(window).width();
    var vph = $(window).height();
    var w = vph*1280/800;
    if(vpw>w){
      vpw=w;
    }else{
      vph = vpw*800/1280;
    }

    if (vph<400){
      vph = 400;
      vpw=640;
    }
    $("#modelContainer").css({
      "height": vph + "px",
      "width" : vpw + "px"
    });

  }
  resize();
  var des = window.opener.g_design;


  $(document).ready(function(){
    paper.setup('pa');

    var addGeoObject = function( group, svgObject ) {
      var pathN = svgObject.length;
      var confirmed_area,newpart ,dep;

      var t = new Path();
      var woodMaterial = new THREE.MeshLambertMaterial( {
        color: new THREE.Color(0xffeecc)
      } );

      var cutting = svgObject.filter(function(e){
        if(e.data.edge){
          return e.data.edge.type =="cutting";
        }else{
          return false;
        }
      })

      $.each(cutting, function(k,v){
        t = t.unite(v);
      })
      var outline = SVGtransform.transformSVGPathTHREE(t.pathData).path;
      var outline_shape = outline.toShapes(true, true);

      var nPieces = outline_shape.length;

      if(nPieces==0){
        console.log('nothing is cut out');
      }else if (nPieces==1){
        confirmed_area = new Path();
        for ( var i = pathN-1; i >-1; i--){
          var p = svgObject[i].intersect(t);
          if(p.area!=0 && svgObject[i].data.edge && svgObject[i].data.edge.type!='cutting'){
            if(p.intersect(confirmed_area).area==0){
              newpart = p;
            }else{
              newpart = p.subtract(confirmed_area);
            }

            confirmed_area = confirmed_area.unite(p);
            dep = svgObject[i].data.fill.depth*100;
            if(dep!=0){
              var threeData,color,material, shape3d, mesh;
              threeData = SVGtransform.transformSVGPathTHREE(newpart.pathData).path.toShapes(true, false);
              color = new THREE.Color(0x996600);
              material = new THREE.MeshLambertMaterial( {
                color: color,
              } );
              shape3d = new THREE.ExtrudeBufferGeometry( threeData, {
                amount: 25.5-dep,
                bevelEnabled: false
              } );
              mesh = new THREE.Mesh( shape3d, [material,woodMaterial,woodMaterial, woodMaterial]);
              mesh.translateZ(dep);
              group.add( mesh );

            }
          }
        }
        var hole = SVGtransform.transformSVGPathTHREE(confirmed_area.pathData).path.toShapes(false, false);
        $.each(hole, function(k,v){
          outline_shape[0].holes.push(v);
        })
        var shape3d = new THREE.ExtrudeBufferGeometry( outline_shape[0], {
            amount: 25.5,
            bevelEnabled: false
          } );
        var mesh = new THREE.Mesh( shape3d, woodMaterial );
        group.add( mesh );



      }else{
        confirmed_area = [];
        for ( var i = pathN-1; i >-1; i--){
          for (var j = 0; j<nPieces; j++){
            var piec = t.children[j];
            var p = svgObject[i].intersect(piec);
            if(p.area!=0 && Math.abs(p.area)<Math.abs(piec.area)){
              if(!confirmed_area[j]){
                confirmed_area[j] = new Path();
              }
              if(p.intersect(confirmed_area[j]).area==0){
                newpart = p;
              }else{
                newpart = p.subtract(confirmed_area[j]);
              }
              confirmed_area[j] = confirmed_area[j].unite(p);
              dep = svgObject[i].data.fill.depth*100;
              if(dep!=0){
                var threeData,color,material, shape3d, mesh;
                threeData = SVGtransform.transformSVGPathTHREE(newpart.pathData).path.toShapes(true, false);
                color = new THREE.Color(0x996600);
                material = new THREE.MeshLambertMaterial( {
                  color: color,
                } );
                shape3d = new THREE.ExtrudeBufferGeometry( threeData, {
                  amount: 25.5-dep,
                  bevelEnabled: false
                } );
                mesh = new THREE.Mesh( shape3d, [material,woodMaterial,woodMaterial, woodMaterial]);
                mesh.translateZ(dep);
                group.add( mesh );
              }
            }
          }

        }

        for (var j = 0; j<nPieces; j++){
          var hole = SVGtransform.transformSVGPathTHREE(confirmed_area[j].pathData).path.toShapes(false, false);
          $.each(hole, function(k,v){
            outline_shape[j].holes.push(v);
          })
          var shape3d = new THREE.ExtrudeBufferGeometry( outline_shape[j], {
              amount: 25.5,
              bevelEnabled: false
            } );
          var mesh = new THREE.Mesh( shape3d, woodMaterial );
          group.add( mesh );

        }
      }


      group.rotateZ(Math.PI);
      group.rotateY(Math.PI);
      group.translateX(-(t.bounds.x+t.bounds.width/2));
      group.translateY(-(t.bounds.y+t.bounds.height/2));


    };

    var renderer, scene, camera;

    init();
    animate();

    function init() {

      var container = document.getElementById( 'modelCanvasContainer' );

      scene = new THREE.Scene();

      camera = new THREE.PerspectiveCamera( 50, 1280 / 800, 1, 10000 );
      camera.position.set( 0, 0, 500 );

      axesHelper = new THREE.AxesHelper( 5 );
      scene.add( axesHelper );

      var group = new THREE.Group();
      scene.add( group );

      var directionalLight = new THREE.DirectionalLight( 0xffffff, 0.6 );
      directionalLight.position.set( 0.75, 0.75, 1.0 ).normalize();
      scene.add( directionalLight );

      var ambientLight = new THREE.AmbientLight( 0xffffff, 0.5 );
      scene.add( ambientLight );

      //var geo = getDesign(des);

      addGeoObject( group, des );


      renderer = new THREE.WebGLRenderer( {
        antialias: true,
        alpha: true
      } );
      renderer.setPixelRatio( window.devicePixelRatio );
      renderer.setSize( $("#modelCanvasContainer").width(), $("#modelCanvasContainer").height() );
      renderer.setClearColor( 0x000000, 0 );
      container.appendChild( renderer.domElement );

      //

      var controls = new THREE.OrbitControls( camera, renderer.domElement );
      //

      window.addEventListener( 'resize', onWindowResize, false );

    }
    function onWindowResize() {
      camera.updateProjectionMatrix();

      renderer.setSize( $("#modelCanvasContainer").width(), $("#modelCanvasContainer").height() );

    }

    function animate() {

      requestAnimationFrame( animate );

      render();

    }

    function render() {

      renderer.render( scene, camera );

    }

  })



  </script>

</body>
</html>
